name: Publish (crates.io)

on:
  workflow_dispatch: {}
  push:
    tags:
      - "timeseries-table-core-v*"
      - "timeseries-table-datafusion-v*"
      - "timeseries-table-format-v*"
      - "timeseries-table-cli-v*"

jobs:
  decide:
    name: decide leader tag
    if: ${{ github.repository_owner == 'mag1cfrog' }}
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.decide.outputs.proceed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - id: decide
        shell: bash
        run: |
          set -euo pipefail
          sha="${GITHUB_SHA}"
          current="${GITHUB_REF_NAME}"

          mapfile -t tags < <(git tag --points-at "${sha}")
          echo "Tags on ${sha}: ${tags[*]:-<none>}"

          leader=""
          for pat in \
            "timeseries-table-core-v*" \
            "timeseries-table-datafusion-v*" \
            "timeseries-table-format-v*" \
            "timeseries-table-cli-v*"
          do
            for t in "${tags[@]}"; do
              if [[ "${t}" == ${pat} ]]; then
                leader="${t}"
                break 2
              fi
            done
          done

          echo "Leader tag: ${leader:-<none>}"
          if [[ -n "${leader}" && "${current}" == "${leader}" ]]; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
          else
            echo "proceed=false" >> "$GITHUB_OUTPUT"
          fi

  publish:
    name: publish (crates.io)
    needs: [decide]
    if: ${{ needs.decide.outputs.proceed == 'true' }}
    runs-on: ubuntu-latest
    concurrency:
      group: crates-io-publish
      cancel-in-progress: false
    timeout-minutes: 30
    environment: crates-io-release
    permissions:
      contents: read
      id-token: write
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: "0"
      RUSTFLAGS: "-C debuginfo=0"
      CARGO_NET_RETRY: "10"
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
      # Keep target artifacts stable across steps (and compatible with rust-cache).
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
          shared-key: rust-cache-v1

      - name: Verify tag matches Cargo version
        if: ${{ github.ref_type == 'tag' }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"

          case "${tag}" in
            timeseries-table-core-v*)
              crate="timeseries-table-core"
              crate_dir="crates/timeseries-table-core"
              ;;
            timeseries-table-datafusion-v*)
              crate="timeseries-table-datafusion"
              crate_dir="crates/timeseries-table-datafusion"
              ;;
            timeseries-table-format-v*)
              crate="timeseries-table-format"
              crate_dir="crates/timeseries-table-format"
              ;;
            timeseries-table-cli-v*)
              crate="timeseries-table-cli"
              crate_dir="crates/timeseries-table-cli"
              ;;
            *)
              echo "Unexpected tag format: ${tag}"
              exit 1
              ;;
          esac

          expected="${tag#${crate}-v}"
          actual="$(
            python3 -c "import tomllib, pathlib; print(tomllib.loads(pathlib.Path('${crate_dir}/Cargo.toml').read_text(encoding='utf-8'))['package']['version'])"
          )"
          if [[ "${actual}" != "${expected}" ]]; then
            echo "Tag/version mismatch for ${crate}: tag=${expected} cargo=${actual}"
            exit 1
          fi

      - name: Mint crates.io token (OIDC)
        id: cratesio
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish crates (skip already-published versions)
        shell: bash
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.cratesio.outputs.token }}
        run: |
          set -euo pipefail
          ua="mag1cfrog/timeseries-table-format publish-crates (GitHub Actions)"

          has_tag_on_sha() {
            local tag="$1"
            git tag --points-at "${GITHUB_SHA}" | grep -Fxq "${tag}"
          }

          has_version() {
            local crate="$1"
            local ver="$2"
            curl -A "${ua}" -fsS "https://crates.io/api/v1/crates/${crate}/${ver}" >/dev/null 2>&1
          }

          retry() {
            local attempts="$1"
            local delay_s="$2"
            shift 2

            local i
            for ((i=1; i<=attempts; i++)); do
              if "$@"; then
                return 0
              fi
              if (( i == attempts )); then
                return 1
              fi
              echo "Retrying ($i/${attempts}) after ${delay_s}s: $*"
              sleep "${delay_s}"
              delay_s="$((delay_s * 2))"
              if (( delay_s > 60 )); then
                delay_s=60
              fi
            done
          }

          wait_for_registry() {
            local crate="$1"
            local ver="$2"

            local tmp
            tmp="$(mktemp -d)"
            mkdir -p "${tmp}/src"
            {
              printf '%s\n' \
                '[package]' \
                'name = "registry-probe"' \
                'version = "0.0.0"' \
                'edition = "2021"' \
                '' \
                '[dependencies]' \
                "${crate} = \"=${ver}\""
            } >"${tmp}/Cargo.toml"
            echo "fn main() {}" >"${tmp}/src/main.rs"

            retry 10 5 bash -lc "cd '${tmp}' && cargo fetch -q"
          }

          publish_if_missing() {
            local crate="$1"
            local ver="$2"
            if has_version "${crate}" "${ver}"; then
              echo "Skipping ${crate} v${ver} (already on crates.io)"
              return 0
            fi
            if ! has_tag_on_sha "${crate}-v${ver}"; then
              echo "Refusing to publish ${crate} v${ver}: tag ${crate}-v${ver} is not on commit ${GITHUB_SHA}"
              return 1
            fi
            echo "Publishing ${crate} v${ver}"
            if ! retry 5 15 cargo publish -p "${crate}"; then
              if has_version "${crate}" "${ver}"; then
                echo "cargo publish failed but ${crate} v${ver} exists on crates.io; continuing"
              else
                return 1
              fi
            fi
            if [[ "${crate}" != "timeseries-table-cli" ]]; then
              wait_for_registry "${crate}" "${ver}"
            fi
          }

          core_ver="$(python3 -c 'import tomllib, pathlib; print(tomllib.loads(pathlib.Path("crates/timeseries-table-core/Cargo.toml").read_text(encoding="utf-8"))["package"]["version"])')"
          df_ver="$(python3 -c 'import tomllib, pathlib; print(tomllib.loads(pathlib.Path("crates/timeseries-table-datafusion/Cargo.toml").read_text(encoding="utf-8"))["package"]["version"])')"
          fmt_ver="$(python3 -c 'import tomllib, pathlib; print(tomllib.loads(pathlib.Path("crates/timeseries-table-format/Cargo.toml").read_text(encoding="utf-8"))["package"]["version"])')"
          cli_ver="$(python3 -c 'import tomllib, pathlib; print(tomllib.loads(pathlib.Path("crates/timeseries-table-cli/Cargo.toml").read_text(encoding="utf-8"))["package"]["version"])')"

          # Only publish versions that correspond to tags on this commit (release-plz creates per-crate tags).
          core_tag="timeseries-table-core-v${core_ver}"
          df_tag="timeseries-table-datafusion-v${df_ver}"
          fmt_tag="timeseries-table-format-v${fmt_ver}"
          cli_tag="timeseries-table-cli-v${cli_ver}"

          core_on_sha=false
          df_on_sha=false
          fmt_on_sha=false
          cli_on_sha=false
          if has_tag_on_sha "${core_tag}"; then core_on_sha=true; fi
          if has_tag_on_sha "${df_tag}"; then df_on_sha=true; fi
          if has_tag_on_sha "${fmt_tag}"; then fmt_on_sha=true; fi
          if has_tag_on_sha "${cli_tag}"; then cli_on_sha=true; fi

          echo "Tag matrix on ${GITHUB_SHA}: core=${core_on_sha} df=${df_on_sha} fmt=${fmt_on_sha} cli=${cli_on_sha}"

          if [[ "${core_on_sha}" == true ]]; then
            publish_if_missing "timeseries-table-core" "${core_ver}"
          fi
          if [[ "${df_on_sha}" == true ]]; then
            publish_if_missing "timeseries-table-core" "${core_ver}"
            publish_if_missing "timeseries-table-datafusion" "${df_ver}"
          fi
          if [[ "${fmt_on_sha}" == true ]]; then
            publish_if_missing "timeseries-table-core" "${core_ver}"
            publish_if_missing "timeseries-table-datafusion" "${df_ver}"
            publish_if_missing "timeseries-table-format" "${fmt_ver}"
          fi
          if [[ "${cli_on_sha}" == true ]]; then
            publish_if_missing "timeseries-table-core" "${core_ver}"
            publish_if_missing "timeseries-table-datafusion" "${df_ver}"
            publish_if_missing "timeseries-table-cli" "${cli_ver}"
          fi
